<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HNN Textbook</title>
    <!-- <base href="/textbook/"> -->
    <link href="https://fonts.googleapis.com/css2?family=Fira+Sans:wght@400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../assets/styles.css">
    <script src="../../templates/scripts.js" defer></script>
</head>
<body>
    <svg style="display: none;">
        <symbol id="popup-symbol" viewBox="0 0 24 24" fill="none">
            <circle cx="12" cy="12" r="9" 
                fill="var(--fill-color, transparent)" 
                stroke="var(--stroke-color, currentColor)" 
                stroke-width="2" />
            <path d="M9 9L15 15M15 9L9 15" 
                stroke="var(--stroke-color, currentColor)" 
                stroke-width="2" 
                stroke-linecap="round" />
        </symbol>
    </svg>

	<div id="mySidebar" class="sidebar">
		<div class="sidebar-close">
		<svg class="popup-symbol" viewBox="0 0 24 24">
		<use href="#popup-symbol" />
		</svg>
		</div>
		<div class="navbar-header">
		<a>
			Human Neocortical Neurosolver
		</a>
		<br>
			<svg class="collapse-icon" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16">
				<path d="M9 9H4v1h5V9z"/>
				<path fill-rule="evenodd" clip-rule="evenodd" d="M5 3l1-1h7l1 1v7l-1 1h-2v2l-1 1H3l-1-1V6l1-1h2V3zm1 2h4l1 1v4h2V3H6v2zm4 1H3v7h7V6z"/>
			</svg>
		</div>
		<a href="/textbook/content/preface.html">Preface</a>
		<div class="sidebar-list">
			<a id="sidebar-header" onclick="toggleSubmenu(event)">
		<span class="toggle-icon">+</span>
				1. Getting Started
			</a>
			<div class="submenu">
				<a href="/textbook/content/01_getting_started/challenge.html">1.1 Introducing HNN</a>
				<a href="/textbook/content/01_getting_started/template_model.html">1.2 Template Model</a>
				<a href="/textbook/content/01_getting_started/installation.html">1.3 Installation</a>
			</div>
		</div>
		<div class="sidebar-list">
			<a id="sidebar-header" onclick="toggleSubmenu(event)">
		<span class="toggle-icon">+</span>
				2. Model Assumptions
			</a>
			<div class="submenu">
				<a href="/textbook/content/03_model_assumptions/cortical_column_structure.html">2.1 Cortical Column Structure</a>
				<a href="/textbook/content/03_model_assumptions/primary_electric_currents.html">2.2 Primary Electrical Currents</a>
				<a href="/textbook/content/03_model_assumptions/neurons_morphology_and_physiology.html">2.3 Neurons: Morphology and Physiology</a>
				<a href="/textbook/content/03_model_assumptions/synaptic_connectivity.html">2.4 Synaptic Connectivity</a>
				<a href="/textbook/content/03_model_assumptions/evoked_and_rhythmic_driving_inputs.html">2.5 Evoked and Rhythmic Driving Inputs</a>
				<a href="/textbook/content/03_model_assumptions/tonic_and_noisy_driving_inputs.html">2.6 Tonic and Noisy Driving Inputs</a>
			</div>
		</div>
		<div class="sidebar-list">
			<a id="sidebar-header" onclick="toggleSubmenu(event)">
		<span class="toggle-icon">+</span>
				3. Using the HNN GUI
			</a>
			<div class="submenu">
				<a href="/textbook/content/04_using_hnn_gui/gui_quickstart.html">3.1 GUI Quickstart</a>
			</div>
		</div>
		<div class="sidebar-list">
			<a id="sidebar-header" onclick="toggleSubmenu(event)">
		<span class="toggle-icon">+</span>
				4. Simulating ERPs
			</a>
			<div class="submenu">
				<a href="/textbook/content/05_erps/erps_in_gui.html">4.1 GUI Tutorial of ERPs Simulation</a>
				<a href="/textbook/content/05_erps/hnn_core.html">4.2 API Tutorial of ERPs Simulation</a>
			</div>
		</div>
		<div class="sidebar-list">
			<a id="sidebar-header" onclick="toggleSubmenu(event)">
		<span class="toggle-icon">+</span>
				5. Simulating Alpha/Beta Rhythms
			</a>
			<div class="submenu">
				<a href="/textbook/content/06_alpha_beta/gui.html">5.1 GUI Tutorial of Alpha/Beta Rhythms</a>
				<a href="/textbook/content/06_alpha_beta/api.html">5.2 API Tutorial of Alpha/Beta Rhythms</a>
			</div>
		</div>
		<div class="sidebar-list">
			<a id="sidebar-header" onclick="toggleSubmenu(event)">
		<span class="toggle-icon">+</span>
				6. Simulating Gamma Rhythms
			</a>
			<div class="submenu">
				<a href="/textbook/content/07_gamma/gamma_in_gui.html">6.1 GUI Tutorial of Gamma Rhythms</a>
				<a href="/textbook/content/07_gamma/gamma_in_api.html">6.2 API Tutorial of Gamma Rhythms</a>
			</div>
		</div>
		<div class="sidebar-list">
			<a id="sidebar-header" onclick="toggleSubmenu(event)">
		<span class="toggle-icon">+</span>
				7. Using the HNN API
			</a>
			<div class="submenu">
				<a href="/textbook/content/08_using_hnn_api/plot_firing_pattern.html">7.1 Plot Firing Pattern</a>
				<a href="/textbook/content/08_using_hnn_api/record_and_plot_extracellular_potentials.html">7.2 Record & Plot Extracellular Potentials</a>
				<a href="/textbook/content/08_using_hnn_api/modifying_local_connectivity.html">7.3 Modifying Local Connectivity</a>
				<a href="/textbook/content/08_using_hnn_api/animating_hnn_simulations.html">7.4 Animating HNN Simulations</a>
				<a href="/textbook/content/08_using_hnn_api/batch_simulation.html">7.5 Batch Simulation</a>
				<a href="/textbook/content/08_using_hnn_api/simulate_beta_modulated_erp.html">7.6 Simulate Beta-modulated ERP</a>
				<a href="/textbook/content/08_using_hnn_api/parallelism_joblib.html">7.7 Parallelism: Joblib</a>
				<a href="/textbook/content/08_using_hnn_api/parallelism_mpi.html">7.8 Parallelism: MPI</a>
				<a href="/textbook/content/08_using_hnn_api/optimize_simulated_evoked_response_parameters.html">7.9 Optimize simulated evoked response parameters</a>
				<a href="/textbook/content/08_using_hnn_api/optimize_simulated_rhythmic_response_parameters.html">7.10 Optimize simulated rhythmic response parameters</a>
			</div>
		</div>
		<div class="sidebar-list">
			<a id="sidebar-header" onclick="toggleSubmenu(event)">
		<span class="toggle-icon">+</span>
				8. From Data to Simulation
			</a>
			<div class="submenu">
				<a href="/textbook/content/09_data_to_simulation/from_meg_to_hnn.html">8.1 From MEG sensor-space data to HNN simulation</a>
			</div>
		</div>
	<div style='height: 30px;'></div>
	</div>


    <div class="topbar">
        
        <!-- Topbar menu -->
        <div class="menu-container">
            <div class="menu-icons">
                <button class="openbtn" onclick="toggleNav()">
                    ☰
                </button>
                <a href="https://hnn.brown.edu" class="home-link">
                    <div class="home-icon-container">
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            width="24" 
                            height="24"
                            viewBox="0 0 24 24" 
                            class="home-icon">
                            <path
                                d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"
                            />
                        </svg>
                    </div>
                </a>
                <button class="theme-toggle">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
                        <path d="M361.5 1.2c5 2.1 8.6 6.6 9.6 11.9L391 121l107.9 19.8c5.3 1 9.8 4.6 11.9 9.6s1.5 10.7-1.6 15.2L446.9 256l62.3 90.3c3.1 4.5 3.7 10.2 1.6 15.2s-6.6 8.6-11.9 9.6L391 391 371.1 498.9c-1 5.3-4.6 9.8-9.6 11.9s-10.7 1.5-15.2-1.6L256 446.9l-90.3 62.3c-4.5 3.1-10.2 3.7-15.2 1.6s-8.6-6.6-9.6-11.9L121 391 13.1 371.1c-5.3-1-9.8-4.6-11.9-9.6s-1.5-10.7 1.6-15.2L65.1 256 2.8 165.7c-3.1-4.5-3.7-10.2-1.6-15.2s6.6-8.6 11.9-9.6L121 121 140.9 13.1c1-5.3 4.6-9.8 9.6-11.9s10.7-1.5 15.2 1.6L256 65.1 346.3 2.8c4.5-3.1 10.2-3.7 15.2-1.6zM160 256a96 96 0 1 1 192 0 96 96 0 1 1 -192 0zm224 0a128 128 0 1 0 -256 0 128 128 0 1 0 256 0z"></path>
                    </svg>
                </button>
                <div class="dropdown">
                    <button 
                        id="dropdownButton" 
                        class="dropdown-button">
                            <img
                                src="/textbook/content/assets/icons/fontsize.png"
                                alt="fontsize"
                            />
                    </button>
                    <div class="dropdown-content">
                        <button 
                            class="fontsize-btn" 
                            onclick="decreaseFontSize()">
                            <img
                                src="/textbook/content/assets/icons/fontminus.png"
                                alt="fontminus"
                            />
                        </button>
                        <button 
                            class="fontsize-btn" 
                            onclick="increaseFontSize()">
                            <img
                                src="/textbook/content/assets/icons/fontplus.png"
                                alt="fontplus"
                            />
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Topbar image -->
        <div class="topbar-logo-container">
            <img 
                id="topbar-logo"
                src="https://raw.githubusercontent.com/jonescompneurolab/jones-website/master/images/frontpage/logos/logo-hnn-medium.png"
            />
        </div>

        <!-- Right side of topbar -->
        <div class="socials-container">
            <div class="social-icons">
                <a 
                    href="https://github.com/jonescompneurolab/hnn-core" 
                    target="_blank" 
                    aria-label="GitHub">
                    <img 
                        src="/textbook/content/assets/icons/github.png"
                        alt="GitHub">
                </a>
                <a 
                    href="https://bsky.app/profile/hnnsolver.bsky.social" 
                    target="_blank"
                    aria-label="BlueSky">
                    <img 
                        src="/textbook/content/assets/icons/bluesky.png"
                        alt="BlueSky">
                </a>
                <a 
                    href="https://www.linkedin.com/company/human-neocortical-neurosolver/" 
                    target="_blank"
                    aria-label="LinkedIn">
                    <img 
                        src="/textbook/content/assets/icons/linkedin.png"
                        alt="LinkedIn">
                </a>
            </div>
        </div>
    </div>

    <div id="main">
    <div id="content-wrapper">
    <div id="content">

<!--
# Title: 7.2 Record & Plot Extracellular Potentials
# Updated: 2025-02-04
#
# Contributors:
    # Dylan Daniels
-->

		<div class="notebook-download-wrapper">
		    <a href='record_and_plot_extracellular_potentials_notebook.ipynb' download>
		        <button class="notebook-download">
		            <svg xmlns="http://www.w3.org/2000/svg"
		                width="20" height="20" viewBox="0 0 24 24" fill="none"
		                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
		                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
		                <polyline points="7 10 12 15 17 10"/>
		                <line x1="12" y1="15" x2="12" y2="3"/>
		            </svg>
		            <span style="width: 8px"></span>
		            <span>Download Notebook</span>
		        </button>
		    </a>
		</div>


<div class='markdown-cell'>
    <h1>7.2: Record and plot extracellular potentials</h1>
<p>The main output of HNN simulations is the 'dipole' waveform, i.e.,
the net intracellular current flowing in pyramidal cell apical
dendrites. At the large distances between cells and M/EEG sensors, this
'primary' current is the main contributor to the measured fields. Close
to the cells, the local field potential (LFP) is the result of
intracellular current leaking into the extracellular medium through
active and passive membrane channels. Under some simplifying
assumptions, we may approximate the LFP at virtual electrodes placed in
and around the HNN network model.</p>

</div>
<div class='code-cell'>
    <code class='language-python'>
        # Authors: Christopher Bailey <cjb@cfin.au.dk>
#          Mainak Jas <mainakjas@gmail.com>
#          Nick Tolley <nicholas_tolley@brown.edu>

import matplotlib.pyplot as plt

from hnn_core import jones_2009_model, simulate_dipole
from hnn_core.network_models import add_erp_drives_to_jones_model
    </code>
</div>
<div class='markdown-cell'>
    <p>The default network model defined in (Jones et al. 2009) consists of
a square grid of pyramidal cells. The in-plane distance between
pyramidal cell somas on the grid can be set by the user, which will have
an influence on the extracellular potentials (but not on the calculated
net intracellular dipole moment). In this example, we'll simulate a
network of model cells spaced 30 um apart. To drive the network
dynamics, we'll use three evoked 'ERP' drives; see the event-related
potential (ERP) example for details.</p>

</div>
<div class='code-cell'>
    <code class='language-python'>
        net = jones_2009_model()
add_erp_drives_to_jones_model(net)

net.set_cell_positions(inplane_distance=30.)
    </code>
</div>
<div class='markdown-cell'>
    <p>Extracellular recordings require specifying the electrode positions.
It can be useful to visualize the cells of the network to decide on the
placement of each electrode.</p>

</div>
<div class='code-cell'>
    <code class='language-python'>
        net.plot_cells(show=False)
plt.show()
    </code>
</div>
<div class='output-cell'><div class='output-label'>
    Out:
</div>
    <div class='output-code'>
        &lt;Figure size 640x480 with 1 Axes&gt;
    </div>
</div>
<div class='output-cell'>
    <img src='output_nb_record_and_plot_extracellular_potentials_notebook/fig_01.png'/>
</div>
<div class='markdown-cell'>
    <p>The default network consists of 2 layers (L2 and L5), within which
the cell somas are arranged in a regular grid, and apical dendrites are
aligned along the z-axis. We can simulate a linear multielectrode array
with 100 um intercontact spacing (Kajikawa and Schroeder 2011) by
specifying a list of (x, y, z) coordinate triplets. The L5 pyramidal
cell somas are at z=0 um, with apical dendrites extending up to z~2000
um. L2 pyramidal cell somas reside at z~1300 um, and have apical
dendrites extending to z~2300 um. We'll place the recording array in the
center of the network. By default, a value of 0.3 S/m is used for the
constant extracellular conductivity and the 'point source approximation'
for calculations; see <a
href="https://jonescompneurolab.github.io/hnn-core/stable/generated/hnn_core.Network.html#hnn_core.Network.add_electrode_array">hnn_core.Network.add_electrode_array</a>
for details.</p>

</div>
<div class='code-cell'>
    <code class='language-python'>
        depths = list(range(-325, 2150, 100))
electrode_pos = [(135, 135, dep) for dep in depths]
net.add_electrode_array('shank1', electrode_pos)
    </code>
</div>
<div class='markdown-cell'>
    <p>The electrode arrays are stored under <code>Network.rec_arrays</code>
as a dictionary of <a
href="https://jonescompneurolab.github.io/hnn-core/stable/generated/hnn_core.extracellular.ExtracellularArray.html#hnn_core.extracellular.ExtracellularArray">hnn_core.extracellular.ExtracellularArray</a>
objects that are now attached to the network and will be recorded during
the simulation. Note that calculating the extracellular potentials
requires additional computational resources and will thus slightly slow
down the simulation. <a
href="https://jonescompneurolab.github.io/textbook/content/09_feature_demos/use_mpi_backend_for_parallelization.html">Using
MPI</a> will speed up computation considerably.</p>

</div>
<div class='code-cell'>
    <code class='language-python'>
        print(net.rec_arrays)
net.plot_cells(show=False)
plt.show()

dpl = simulate_dipole(net, tstop=170)
    </code>
</div>
<div class='output-cell'><div class='output-label'>
    Out:
</div>
    <div class='output-code'>
        {&#x27;shank1&#x27;: &lt;ExtracellularArray | 25 electrodes, conductivity=0.3, method=psa (no data recorded yet)&gt;}

        &lt;Figure size 640x480 with 1 Axes&gt;
    </div>
</div>
<div class='output-cell'>
    <img src='output_nb_record_and_plot_extracellular_potentials_notebook/fig_02.png'/>
</div>
<div class='output-cell'><div class='output-label'>
    Out:
</div>
    <div class='output-code'>
        Joblib will run 1 trial(s) in parallel by distributing trials over 1 jobs.
Loading custom mechanism files from /usr/share/miniconda/envs/textbook-env-mpi/lib/python3.12/site-packages/hnn_core/mod/x86_64/libnrnmech.so
Building the NEURON model

        [Done]
Trial 1: 0.03 ms...

        Trial 1: 10.0 ms...

        Trial 1: 20.0 ms...

        Trial 1: 30.0 ms...

        Trial 1: 40.0 ms...

        Trial 1: 50.0 ms...

        Trial 1: 60.0 ms...

        Trial 1: 70.0 ms...

        Trial 1: 80.0 ms...

        Trial 1: 90.0 ms...

        Trial 1: 100.0 ms...

        Trial 1: 110.0 ms...

        Trial 1: 120.0 ms...

        Trial 1: 130.0 ms...

        Trial 1: 140.0 ms...

        Trial 1: 150.0 ms...

        Trial 1: 160.0 ms...

    </div>
</div>
<div class='markdown-cell'>
    <p>For plotting both aggregate dipole moment and LFP traces, we'll use a
10 ms smoothing window, after which both data can be decimated by a
factor of 20 from 40 to 2 kHz sampling rates (note that decimation is
applied in two steps). Decimation speeds up plotting significantly.</p>

</div>
<div class='code-cell'>
    <code class='language-python'>
        trial_idx = 0
window_len = 10  # ms
decimate = [5, 4]  # from 40k to 8k to 2k

# Then plot the aggregate dipole time series on its own axis
dpl[trial_idx].smooth(window_len=window_len)

# Use the same smoothing window on the LFP traces to allow comparison to dipole
electrode_data = net.rec_arrays['shank1'][trial_idx].smooth(window_len=window_len)
    </code>
</div>
<div class='code-cell'>
    <code class='language-python'>
        fig, axs = plt.subplots(4, 1, 
                        sharex=True, 
                        figsize=(6, 8),
                        gridspec_kw={'height_ratios': [1, 2, 2, 2]})

dpl[trial_idx].plot(ax=axs[0], decim=decimate, show=False)
axs[0].set_xlabel('')
axs[0].set_ylabel('Dipole moment\n(nAm)')
axs[0].set_title('Aggregate Dipole (L2/3 + L5)')

# Add spike raster to subplot
net.cell_response.plot_spikes_raster(ax=axs[1], show=False)
axs[1].set_xlabel('')
axs[1].set_title('Raster Plot')

# Add smoothed LFP traces to next subplot
electrode_data.plot_lfp(ax=axs[2], decim=decimate, show=False)
axs[2].grid(True, which='major', axis='x')
axs[2].set_xlabel('')
axs[2].set_yticklabels('')
axs[2].set_title('LFP Traces')

# Finally, add the CSD to the bottom subplot
electrode_data.plot_csd(ax=axs[3], show=False)
axs[3].set_xlabel('Time (ms)')
axs[3].set_ylabel('Electrode depth (um)')
axs[3].set_title('CSD Plot')
plt.tight_layout()
plt.show()
    </code>
</div>
<div class='output-cell'><div class='output-label'>
    Out:
</div>
    <div class='output-code'>
        &lt;Figure size 600x800 with 4 Axes&gt;
    </div>
</div>
<div class='output-cell'>
    <img src='output_nb_record_and_plot_extracellular_potentials_notebook/fig_03.png'/>
</div><div class='markdown-cell'>
    <h2>References</h2>
<ul>
<li><p>Jones, Stephanie R., Dominique L. Pritchett, Michael A. Sikora,
Steven M. Stufflebeam, Matti Hämäläinen, and Christopher I. Moore. 2009.
“Quantitative Analysis and Biophysically Realistic Neural Modeling of
the MEG Mu Rhythm: Rhythmogenesis and Modulation of Sensory-Evoked
Responses.” Journal of Neurophysiology 102 (6): 3554–72. <a
href="https://doi.org/10.1152/jn.00535.2009">https://doi.org/10.1152/jn.00535.2009</a>.</p></li>
<li><p>Kajikawa, Yoshinao, and Charles E. Schroeder. 2011. “How Local Is
the Local Field Potential?” Neuron 72 (5): 847–58. <a
href="https://doi.org/10.1016/j.neuron.2011.09.029">https://doi.org/10.1016/j.neuron.2011.09.029</a>.</p></li>
</ul>

</div>
<div class='code-cell'>
    <code class='language-python'>
        
    </code>
</div>
        <!-- footer area -->
        <!----------------->
        <div class="footer-area">
            <div class="previous-area" data-link="/textbook/content/08_using_hnn_api/plot_firing_pattern.html">
                <div class="previous-icon">
                    <svg class="svg-arrow" width="25" height="25" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path class="arrow-path" d="M15 5L9 12L15 19" />
                    </svg>
                </div>
                <div class="previous-text">
                    <p>Previous</p>
                    <a>7.1 Plot Firing Pattern</a>
                </div>
            </div>
            <div class="next-area" data-link="/textbook/content/08_using_hnn_api/modifying_local_connectivity.html">
                <div class="next-text">
                    <p>Next</p>
                    <a>7.3 Modifying Local Connectivity</a>
                </div>
                <div class="next-icon">
                    <svg class="svg-arrow" width="25" height="25" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path class="arrow-path" d="M15 5L9 12L15 19" />
                    </svg>
                </div>
            </div>
        </div> <!-- close footer -->
    </div> <!-- close content -->
    </div> <!-- close content wrapper -->
</div> <!-- close main --><!------------------------ #
# Code syntax highlighting #
# ------------------------->
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>

<link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />


</body>
</html>